name: Stage 4 - Deploy with ArgoCD

on:
  workflow_run:
    workflows: ["Stage 3 - Policy Enforcement"]
    types: [completed]
  push:
    branches: [main]
    paths:
    - 'k8s/**'
    - 'argocd/**'

jobs:
  update-image-tag:
    name: Update Image Tag
    runs-on: ubuntu-latest
    if: github.event_name == 'repository_dispatch'
    
    steps:
      - name: Checkout manifest repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update image tag in deployment
        run: |
          NEW_IMAGE="${{ github.event.client_payload.image }}"
          echo "Updating image to: $NEW_IMAGE"

          sed -i "s|image: ghcr.io/samjoyap/miju-app-repo:.*|image: $NEW_IMAGE|g" k8s/deployment.yaml
      
      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add k8s/deployment.yaml
          git commit -m "chore: update image tag to ${{ github.event.client_payload.image }}" || echo "No changes"
          git push
  
  argocd-sync-instructions:
    name: ArgoCD Sync Instructions
    runs-on: ubuntu-latest
    
    steps:
      - name: Deployment Instructions
        run: |
          cat << 'EOFINST'
          ðŸš€ ArgoCD Deployment Instructions
          
          Run these commands on your local machine:
          
          1. Apply ArgoCD Application:
             kubectl apply -f argocd/application.yaml
          
          2. Check Application status:
             kubectl get applications -n argocd
          
          3. Sync the application:
             argocd app sync miju-app
          
          4. Watch deployment:
             kubectl get pods -n default -w
          
          5. Access via browser:
             http://app.local
          
          ðŸ“Š ArgoCD UI: https://argocd.local
          EOFINST
  
  verify-deployment:
    name: Deployment Verification Guide
    runs-on: ubuntu-latest
    needs: argocd-sync-instructions
    
    steps:
      - name: Verification Steps
        run: |
          cat << 'EOFVERIFY'
          âœ… Stage 4: Deployment Complete
          
          ðŸ” Verify Deployment:
          
          # Check pods
          kubectl get pods -n default -l app=miju-app
          
          # Check service
          kubectl get svc -n default miju-app-service
          
          # Check ingress
          kubectl get ingress -n default miju-app-ingress
          
          # Test application
          curl http://app.local/health
          
          # View Falco alerts
          kubectl logs -n falco -l app.kubernetes.io/name=falco -f
          
          ðŸŽ‰ DevSecOps Pipeline Complete!
          EOFVERIFY
